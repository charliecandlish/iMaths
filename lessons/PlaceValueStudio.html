<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Place Value Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../assets/css/coach.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            overflow: hidden;
            user-select: none;
            height: 100vh;
            height: -webkit-fill-available;
        }

        /* --- Instruction Container (Standard Pattern) --- */
        .instruction-container {
            position: absolute;
            width: 100%;
            padding: 0 20px;
            z-index: 60;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.8s;
            transform-origin: top center;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
        }

        .instr-focus {
            top: 0;
            height: 100%;
            background-color: #f8fafc;
        }

        .instr-focus h1 {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #f59e0b;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }

        .instr-focus p {
            font-size: 1.4rem;
            line-height: 1.4;
            color: #1e293b;
            text-align: center;
            max-width: 900px;
        }

        .instr-header {
            top: 0;
            height: 120px;
            border-bottom: 1px solid #e2e8f0;
            padding: 10px 0 12px;
        }

        .instr-header h1 {
            font-size: 0.9rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.2rem;
        }

        .instr-header p {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1e293b;
            max-width: 800px;
            text-align: center;
            line-height: 1.2;
        }

        .instr-header #start-step-btn {
            display: none;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Layout --- */
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            padding-top: 130px;
            /* Space for header */
            transition: padding-top 0.8s;
        }

        /* Top: Visuals & Data */
        #top-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
            min-height: 0;
        }

        #visual-stage {
            width: 100%;
            height: 240px;
            /* Fixed height for stability */
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 2rem;
            perspective: 1000px;
        }

        #data-display {
            text-align: center;
            z-index: 10;
        }

        #standard-form {
            font-size: 4rem;
            font-weight: 900;
            color: #1e293b;
            line-height: 1;
            letter-spacing: -0.02em;
            transition: all 0.2s;
        }

        #expanded-form {
            font-size: 1.2rem;
            font-weight: 600;
            color: #64748b;
            margin-top: 8px;
            height: 1.5em;
        }

        #word-form {
            font-size: 1rem;
            font-weight: 500;
            color: #94a3b8;
            margin-top: 4px;
            height: 1.2em;
            font-style: italic;
        }

        /* Bottom: Controls */
        #bottom-section {
            flex: 0 0 auto;
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            width: 100%;
        }

        #control-grid {
            display: flex;
            justify-content: center;
            gap: 12px;
            overflow-x: auto;
            padding: 10px 4px;
            scroll-snap-type: x mandatory;
        }

        .control-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 16px 12px;
            width: 100px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            scroll-snap-align: center;
            transition: all 0.2s;
        }

        .control-card:hover {
            border-color: #fcd34d;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.1);
        }

        .control-card.active {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .card-header {
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            color: #94a3b8;
            text-align: center;
            height: 2.4em;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.1;
        }

        .card-digit {
            font-size: 2.5rem;
            font-weight: 900;
            color: #f59e0b;
            line-height: 1;
        }

        /* Sliders */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 99px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #f59e0b;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.1s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        /* --- 3D Blocks --- */
        .block-group {
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            gap: 2px;
            width: 60px;
            transition: all 0.3s;
        }

        /* Common 3D */
        .b-cube,
        .b-rod,
        .b-flat,
        .b-big-cube {
            position: relative;
            transform-style: preserve-3d;
            transform: rotateX(-20deg) rotateY(-30deg);
            transition: transform 0.3s;
        }

        .b-cube:hover,
        .b-rod:hover,
        .b-flat:hover,
        .b-big-cube:hover {
            transform: rotateX(-20deg) rotateY(-30deg) translateY(-5px);
        }

        /* Sizes (Native CSS) */
        .b-cube {
            width: 10px;
            height: 10px;
            background: #f59e0b;
        }

        /* Ones */
        .b-rod {
            width: 10px;
            height: 40px;
            background: #f59e0b;
        }

        /* Tens */
        .b-flat {
            width: 40px;
            height: 40px;
            background: #f59e0b;
        }

        /* Hundreds */
        .b-big-cube {
            width: 35px;
            height: 35px;
            background: #f59e0b;
        }

        /* Thousands */

        /* Super Sizes (For 10k+) */
        .b-ten-k-cube {
            width: 48px;
            height: 48px;
            background: #f59e0b;
        }

        /* 10,000 (Requested as Big Cube) */
        .b-super-flat {
            width: 96px;
            height: 96px;
            background: #f59e0b;
        }

        /* 100,000 (Flat of Thousands) */
        .b-super-cube {
            width: 80px;
            height: 80px;
            background: #f59e0b;
        }

        /* 1,000,000 (Mega Cube) */
        .b-ten-m-cube {
            width: 120px;
            height: 120px;
            background: #f59e0b;
        }

        /* 10,000,000 (Huge Cube) */

        /* Faces (Pseudo-elements) */
        .b-cube::before,
        .b-rod::before,
        .b-flat::before,
        .b-big-cube::before,
        .b-ten-k-cube::before,
        .b-super-flat::before,
        .b-super-cube::before,
        .b-ten-m-cube::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fbbf24;
            transform-origin: bottom;
        }

        .b-cube::after,
        .b-rod::after,
        .b-flat::after,
        .b-big-cube::after,
        .b-ten-k-cube::after,
        .b-super-flat::after,
        .b-super-cube::after,
        .b-ten-m-cube::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #d97706;
            transform-origin: left;
        }

        /* Specific Transforms for Faces */
        .b-cube::before {
            height: 100%;
            top: -100%;
            transform: rotateX(90deg);
        }

        .b-cube::after {
            width: 100%;
            left: 100%;
            transform: rotateY(90deg);
        }

        .b-rod::before {
            height: 6px;
            top: -6px;
            transform: rotateX(90deg);
        }

        .b-rod::after {
            width: 6px;
            left: 100%;
            transform: rotateY(90deg);
        }

        .b-flat::before {
            height: 4px;
            top: -4px;
            transform: rotateX(90deg);
        }

        .b-flat::after {
            width: 4px;
            left: 100%;
            transform: rotateY(90deg);
        }

        .b-big-cube::before {
            height: 100%;
            top: -100%;
            transform: rotateX(90deg);
        }

        .b-big-cube::after {
            width: 100%;
            left: 100%;
            transform: rotateY(90deg);
        }

        .b-ten-k-cube::before {
            height: 100%;
            top: -100%;
            transform: rotateX(90deg);
        }

        .b-ten-k-cube::after {
            width: 100%;
            left: 100%;
            transform: rotateY(90deg);
        }

        .b-super-flat::before {
            height: 12px;
            top: -12px;
            transform: rotateX(90deg);
        }

        .b-super-flat::after {
            width: 12px;
            left: 100%;
            transform: rotateY(90deg);
        }

        .b-super-cube::before {
            height: 100%;
            top: -100%;
            transform: rotateX(90deg);
        }

        .b-super-cube::after {
            width: 100%;
            left: 100%;
            transform: rotateY(90deg);
        }

        .b-ten-m-cube::before {
            height: 100%;
            top: -100%;
            transform: rotateX(90deg);
        }

        .b-ten-m-cube::after {
            width: 100%;
            left: 100%;
            transform: rotateY(90deg);
        }

        /* Textures */
        .b-rod {
            background: repeating-linear-gradient(to bottom, #f59e0b, #f59e0b 5px, #d97706 6px);
        }

        .b-flat {
            background: repeating-linear-gradient(to right, #f59e0b, #f59e0b 5px, #d97706 6px), repeating-linear-gradient(to bottom, #f59e0b, #f59e0b 5px, #d97706 6px);
            background-blend-mode: multiply;
        }

        .b-big-cube {
            border: 1px solid #d97706;
        }

        .b-big-cube::before {
            border: 1px solid #d97706;
        }

        .b-big-cube::after {
            border: 1px solid #b45309;
        }

        .b-ten-k-cube {
            border: 2px solid #d97706;
        }

        .b-ten-k-cube::before {
            border: 2px solid #d97706;
        }

        .b-ten-k-cube::after {
            border: 2px solid #b45309;
        }

        .b-super-flat {
            background: repeating-linear-gradient(to right, #f59e0b, #f59e0b 23px, #d97706 24px), repeating-linear-gradient(to bottom, #f59e0b, #f59e0b 23px, #d97706 24px);
            background-blend-mode: multiply;
            border: 1px solid #d97706;
        }

        .b-super-cube {
            border: 2px solid #b45309;
        }

        .b-ten-m-cube {
            border: 3px solid #b45309;
        }

        /* Generic Chip */
        .b-chip {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #f59e0b;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 10px;
        }

        /* UI Elements */
        #exit-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 2px solid #e2e8f0;
            color: #94a3b8;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            text-decoration: none;
        }

        #check-btn {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            background: #1e293b;
            color: white;
            padding: 16px;
            border-radius: 16px;
            font-weight: 700;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        #check-btn:hover {
            transform: scale(1.02);
            background: #0f172a;
        }

        #toast {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: #ef4444;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 700;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            z-index: 200;
        }

        #toast.active {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        /* Instruction Overlay */
        .instruction-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            transition: opacity 0.5s;
        }

        .instruction-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>

<body>

    <a href="../index.html" id="exit-btn">✕</a>
    <div class="absolute top-4 right-4 z-50 flex gap-1.5" id="progress-dots"></div>

    <!-- Instruction Container -->
    <div id="instruction-container" class="instruction-container instr-focus">
        <h1 id="level-title" class="font-extrabold px-4 text-center"></h1>
        <p id="level-desc" class="font-medium px-4 mb-8"></p>
        <button id="start-step-btn"
            class="bg-amber-500 text-white px-8 py-3 rounded-xl font-bold text-lg hover:scale-105 transition shadow-lg">Start</button>
    </div>

    <div id="app-container">
        <!-- Top Section: Visuals & Data -->
        <div id="top-section">
            <div id="visual-stage"></div>

            <div id="data-display">
                <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Current Number</div>
                <div id="standard-form">0</div>
                <div id="expanded-form"></div>
                <div id="word-form"></div>
            </div>
        </div>

        <!-- Bottom Section: Controls -->
        <div id="bottom-section">
            <div id="control-grid"></div>
            <div class="mt-4 px-4">
                <button id="check-btn">Check Number →</button>
            </div>
        </div>
    </div>

    <div id="toast">Try again!</div>

    <!-- Final Screen -->
    <div id="final-screen"
        class="hidden absolute inset-0 bg-white flex flex-col items-center justify-center text-center z-50">
        <h1 class="text-5xl font-black text-amber-500 mb-4">Mastered!</h1>
        <p class="text-xl text-slate-500 mb-8">You understand the structure of numbers.</p>
        <button onclick="location.reload()"
            class="bg-slate-100 text-slate-600 px-8 py-4 rounded-2xl font-bold">Replay</button>
    </div>

    <script src="../assets/js/course.js"></script>
    <script src="../assets/js/coach.js"></script>
    <script>
        const STATE = { step: 0, audioCtx: null };
        const STEPS = [
            {
                title: "Building Integers",
                desc: "Construct the number <b>3,405</b> using the sliders.",
                goal: "3,405",
                columns: ["Thousands", "Hundreds", "Tens", "Ones"],
                target: [3, 4, 0, 5],
                coach: "Watch the expanded form as you move the sliders."
            },
            {
                title: "Large Numbers",
                desc: "Build <b>25,030</b>. Pay attention to the zero placeholder.",
                goal: "25,030",
                columns: ["Ten Thousands", "Thousands", "Hundreds", "Tens", "Ones"],
                target: [2, 5, 0, 3, 0],
                coach: "Zero means 'no value' in that column, but it holds the place!"
            },
            {
                title: "Decimals",
                desc: "Let's get precise. Make <b>4.25</b>.",
                goal: "4.25",
                columns: ["Ones", "Tenths", "Hundredths"],
                target: [4, 2, 5],
                coach: "Decimals are parts of a whole. Tenths are 1/10, Hundredths are 1/100."
            },
            {
                title: "The Millions",
                desc: "Go big! <b>10,000,000</b>.",
                goal: "10,000,000",
                columns: ["Ten Millions", "Millions", "Hundred Thousands", "Ten Thousands", "Thousands", "Hundreds", "Tens", "Ones"],
                target: [1, 0, 0, 0, 0, 0, 0, 0],
                coach: "Ten Millions are 10 times bigger than Millions."
            }
        ];

        // --- Logic ---
        const visualStage = document.getElementById('visual-stage');
        const controlGrid = document.getElementById('control-grid');
        const standardForm = document.getElementById('standard-form');
        const expandedForm = document.getElementById('expanded-form');
        const wordForm = document.getElementById('word-form');
        const instrContainer = document.getElementById('instruction-container');
        const startStepBtn = document.getElementById('start-step-btn');
        const dotsContainer = document.getElementById('progress-dots');
        const titleEl = document.getElementById('level-title');
        const descEl = document.getElementById('level-desc');

        function initLevel() {
            const step = STEPS[STATE.step];

            // Reset Instruction View (Focus Mode)
            instrContainer.className = "instruction-container instr-focus";
            titleEl.textContent = step.title;
            descEl.innerHTML = step.desc;
            startStepBtn.style.display = 'block';

            // Update Dots
            dotsContainer.innerHTML = STEPS.map((_, i) => `<div class="w-2 h-2 rounded-full transition-colors ${i <= STATE.step ? 'bg-amber-500' : 'bg-slate-200'}"></div>`).join('');

            // Setup Grid
            controlGrid.innerHTML = '';
            visualStage.innerHTML = '';

            step.columns.forEach((col, idx) => {
                // Control Card
                const card = document.createElement('div');
                card.className = 'control-card';
                // Add tap interaction
                card.onclick = (e) => {
                    if (e.target.tagName === 'INPUT') return; // Let slider work
                    handleTap(idx);
                };
                card.style.cursor = 'pointer'; // Indicate clickable

                card.innerHTML = `
                    <div class="card-header">${col}</div>
                    <div class="card-digit" id="digit-${idx}">0</div>
                    <input type="range" min="0" max="9" value="0" data-index="${idx}">
                `;
                controlGrid.appendChild(card);

                // Visual Group
                const group = document.createElement('div');
                group.className = 'block-group';
                group.id = `group-${idx}`;
                visualStage.appendChild(group);
            });

            // Listeners
            controlGrid.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', handleInput);
            });

            updateDisplay();
        }

        startStepBtn.onclick = () => {
            const step = STEPS[STATE.step];
            // Transition to Header Mode
            instrContainer.className = "instruction-container instr-header";
            // Show concise goal in header
            descEl.innerHTML = `Target: <span class="text-amber-600">${step.goal}</span>`;
            startStepBtn.style.display = 'none';
            initAudio();
        };

        function handleTap(idx) {
            const input = document.querySelector(`input[data-index="${idx}"]`);
            let val = parseInt(input.value);
            val = (val + 1) % 10; // Cycle 0-9
            input.value = val;

            // Trigger update
            handleInput({ target: input });
        }

        function handleInput(e) {
            const idx = e.target.dataset.index;
            const val = parseInt(e.target.value);
            document.getElementById(`digit-${idx}`).textContent = val;

            // Update Visuals
            const group = document.getElementById(`group-${idx}`);
            const colName = STEPS[STATE.step].columns[idx];
            renderBlocks(group, val, colName);

            updateDisplay();
            playSound('pop');
        }

        function updateDisplay() {
            // Calculate Value
            let total = 0;
            const step = STEPS[STATE.step];
            const inputs = controlGrid.querySelectorAll('input');

            // This is tricky because columns vary. 
            // We need to know the place value of each column.
            // Simple parsing of column name:

            let numStr = "";
            let val = 0;

            // For Standard Form, we can just construct it or calculate it.
            // Let's calculate to be safe.
            let currentVal = 0;

            inputs.forEach((input, i) => {
                const digit = parseInt(input.value);
                const col = step.columns[i].toLowerCase();
                let multiplier = 1;

                if (col.includes('ten million')) multiplier = 10000000;
                else if (col.includes('million')) multiplier = 1000000;
                else if (col.includes('hundred thousand')) multiplier = 100000;
                else if (col.includes('ten thousand')) multiplier = 10000;
                else if (col.includes('thousand')) multiplier = 1000;
                else if (col.includes('hundred') && !col.includes('th')) multiplier = 100;
                else if (col.includes('ten') && !col.includes('th')) multiplier = 10;
                else if (col.includes('one')) multiplier = 1;
                else if (col.includes('tenth')) multiplier = 0.1;
                else if (col.includes('hundredth')) multiplier = 0.01;

                currentVal += digit * multiplier;
            });

            // Fix floating point
            currentVal = parseFloat(currentVal.toFixed(2));

            // Standard Form
            standardForm.textContent = currentVal.toLocaleString();

            // Expanded Form
            let expanded = [];
            inputs.forEach((input, i) => {
                const digit = parseInt(input.value);
                if (digit === 0) return;

                const col = step.columns[i].toLowerCase();
                let valStr = "";

                if (col.includes('ten million')) valStr = (digit * 10000000).toLocaleString();
                else if (col.includes('million')) valStr = (digit * 1000000).toLocaleString();
                else if (col.includes('hundred thousand')) valStr = (digit * 100000).toLocaleString();
                else if (col.includes('ten thousand')) valStr = (digit * 10000).toLocaleString();
                else if (col.includes('thousand')) valStr = (digit * 1000).toLocaleString();
                else if (col.includes('hundred') && !col.includes('th')) valStr = (digit * 100).toString();
                else if (col.includes('ten') && !col.includes('th')) valStr = (digit * 10).toString();
                else if (col.includes('one')) valStr = digit.toString();
                else if (col.includes('tenth')) valStr = (digit * 0.1).toFixed(1);
                else if (col.includes('hundredth')) valStr = (digit * 0.01).toFixed(2);

                expanded.push(valStr);
            });
            expandedForm.textContent = expanded.join(' + ');

            // Word Form
            wordForm.textContent = toWords(currentVal);
        }

        function renderBlocks(container, count, type) {
            // Keep label
            const label = container.querySelector('.group-label');
            container.innerHTML = '';
            if (label) container.appendChild(label);

            let className = 'b-chip'; // Default

            const t = type.toLowerCase();

            // Standard Base-10
            if (t.includes('one') && !t.includes('thousand') && !t.includes('million')) className = 'b-cube';
            else if (t.includes('ten') && !t.includes('thousand')) className = 'b-rod';
            else if (t.includes('hundred') && !t.includes('thousand')) className = 'b-flat';
            else if (t.includes('thousand') && !t.includes('ten') && !t.includes('hundred')) className = 'b-big-cube';

            // Super Blocks (10k+)
            else if (t.includes('ten million')) className = 'b-ten-m-cube';
            else if (t.includes('ten thousand')) className = 'b-ten-k-cube';
            else if (t.includes('hundred thousand')) className = 'b-super-flat';
            else if (t.includes('million')) className = 'b-super-cube';

            for (let i = 0; i < count; i++) {
                const div = document.createElement('div');
                div.className = className;
                if (className === 'b-chip') div.textContent = '1';
                container.appendChild(div);
            }
        }

        // --- Utils ---
        function toWords(num) {
            if (num === 0) return "Zero";

            const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];

            function convertGroup(n) {
                let str = '';
                if (n >= 100) {
                    str += ones[Math.floor(n / 100)] + ' Hundred ';
                    n %= 100;
                    if (n > 0) str += 'and ';
                }
                if (n >= 20) {
                    str += tens[Math.floor(n / 10)] + ' ';
                    n %= 10;
                }
                if (n >= 10) {
                    str += teens[n - 10] + ' ';
                    n = 0;
                }
                if (n > 0) {
                    str += ones[n] + ' ';
                }
                return str.trim();
            }

            // Handle Decimals
            const parts = num.toString().split('.');
            let integerPart = parseInt(parts[0]);
            let decimalPart = parts[1] || '';

            let words = '';

            if (integerPart === 0) words = "Zero";
            else {
                if (integerPart >= 1000000) {
                    words += convertGroup(Math.floor(integerPart / 1000000)) + ' Million ';
                    integerPart %= 1000000;
                }
                if (integerPart >= 1000) {
                    words += convertGroup(Math.floor(integerPart / 1000)) + ' Thousand ';
                    integerPart %= 1000;
                }
                if (integerPart > 0) {
                    words += convertGroup(integerPart);
                }
            }

            if (decimalPart.length > 0) {
                words += ' point ';
                for (let char of decimalPart) {
                    words += ones[parseInt(char)] + ' ';
                }
            }

            return words.trim();
        }

        document.getElementById('check-btn').onclick = () => {
            const step = STEPS[STATE.step];
            const inputs = Array.from(controlGrid.querySelectorAll('input'));
            const values = inputs.map(i => parseInt(i.value));

            if (values.every((v, i) => v === step.target[i])) {
                playSound('success');
                STATE.step++;
                if (STATE.step >= STEPS.length) {
                    document.getElementById('final-screen').classList.remove('hidden');
                    document.getElementById('final-screen').classList.add('flex');
                } else {
                    initLevel();
                }
            } else {
                playSound('error');
                const t = document.getElementById('toast');
                t.classList.add('active');
                setTimeout(() => t.classList.remove('active'), 2000);
            }
        };

        // Audio
        function initAudio() { if (!STATE.audioCtx) STATE.audioCtx = new (window.AudioContext || window.webkitAudioContext)(); STATE.audioCtx.resume(); }
        function playSound(type) {
            if (!STATE.audioCtx) return;
            const ctx = STATE.audioCtx;
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            const t = ctx.currentTime;
            if (type === 'pop') { osc.frequency.setValueAtTime(600, t); gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1); osc.start(t); osc.stop(t + 0.1); }
            else if (type === 'success') { osc.frequency.setValueAtTime(440, t); osc.frequency.exponentialRampToValueAtTime(880, t + 0.2); gain.gain.exponentialRampToValueAtTime(0.01, t + 0.5); osc.start(t); osc.stop(t + 0.5); }
            else { osc.type = 'triangle'; osc.frequency.setValueAtTime(150, t); gain.gain.linearRampToValueAtTime(0, t + 0.2); osc.start(t); osc.stop(t + 0.2); }
        }

        initLevel();
    </script>
</body>

</html>